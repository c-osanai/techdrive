<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>【実践編】JavaScriptを使って何か一つ作りあげる。 #27</title>
<link rel="stylesheet" type="text/css" href="css/style.css">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js" type="text/javascript" ></script>
<style></style>
<script type="text/javascript">
  $(function(){

    function scrollPage() {
      $(window).on('scroll', function() {
        var docHeight = $(document).innerHeight(), //ドキュメントの高さ
        windowHeight = $(window).innerHeight(), //ウィンドウの高さ
        pageBottom = docHeight - windowHeight; //ドキュメントの高さ - ウィンドウの高さ
          if(pageBottom <= $(window).scrollTop()) {
            //ウィンドウの一番下までスクロールした時に実行
            ajax();
          }
      });
      console.log(windowHeight);
      console.log(docHeight);
    }

    function ajax(){
      var $loading = $(".loading");
      var def = $.ajax( {
        url: 'https://randomuser.me/api',
        type: "GET",
        dataType : 'json',
        beforeSend:function(){
          $loading.removeClass("is-hide");
        }
      }).done(function( data ) {
        var message = jsonParser(data);
        $( '<li>' + message + '</li>' ).appendTo('ul');

      }).fail(function( data ) {
        $( '<font color="red">読み込みNG(ChromeではNG)</font>' ).appendTo('ul');
      });
      setTimeout(function(){
        $.when(def).done(function(data){
          $loading.addClass("is-hide");
        });
      },400);
    }

    function jsonParser(data) {
      var message = '名前<br/>' + data.results[0].name.first　+ ' ' + data.results[0].name.last + '<br/>';
      message = message + '住所<br/>' + data.results[0].location.city + ' ' + data.results[0].location.street + '<br/>';
      message = message + '写真<br/>' + '<img src="' + data.results[0].picture.medium + '">';
      return message;
    }

    scrollPage();

  });
</script>
</head>
<body>

<div class="main">
  <div class="loading is-hide">
    <div class="loading_icon"></div>
  </div>

  <div class="area">

    <ul></ul>
  </div>
</div>

<footer></footer>
</body>
</html>
